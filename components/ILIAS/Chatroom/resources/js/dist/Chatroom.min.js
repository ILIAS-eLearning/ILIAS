/**
 * This file is part of ILIAS, a powerful learning management system
 * published by ILIAS open source e-Learning e.V.
 *
 * ILIAS is licensed with the GPL-3.0,
 * see https://www.gnu.org/licenses/gpl-3.0.en.html
 * You should have received a copy of said license along with the
 * source code, too.
 *
 * If this is not the case or you just want to try ILIAS, you'll find
 * us at:
 * https://www.ilias.de
 * https://github.com/ILIAS-eLearning
 */
!function(e,t){"use strict";function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=s(e),n=s(t);function r(){const e={},t={};return{send(s,i){if(e[s])throw new Error("Name already provided.");e[s]=i;const n=t[s]||[];delete t[s],n.forEach((e=>e(i)))},onArrived(s,i){e[s]?i(e[s]):(t[s]=t[s]||[],t[s].push(i))}}}var o=r();const a=["padding-top","padding-bottom","padding-left","padding-right","margin-left","margin-right","margin-top","margin-bottom","width","font-size","font-family","font-style","font-weight","line-height","font-variant","text-transform","letter-spacing","border","box-sizing","display"],l=(e,t)=>{const s=window.getComputedStyle(e);a.forEach((e=>{t.style[e]=s[e]}))},c=e=>{let t="";return s=>{s!==t&&(e.style.height=s,t=s)}},h=e=>{const t=e.value;e.value="";const s=e.scrollHeight;e.value="\n";const i=e.scrollHeight-s;return e.value=t,i},d=(e,t)=>{const s=e.value;e.value="\n".repeat(t-1);const i=e.scrollHeight;return e.value=s,i},u=e=>{const t=document.createElement("textarea");return t.style.height=window.getComputedStyle(e).height,t.setAttribute("area-hidden","true"),t.readOnly=!0,t.disabled=!0,t},p=e=>{let t=()=>{const s=e();return t=()=>s,s};return()=>t()};function g(e,t,s){const i=u(t),n=c(t),r=p((()=>h(i))),o=p((()=>d(i,s))),a=()=>{i.value="";const e=i.scrollHeight,a=t.clientHeight;i.value=t.value;const l=i.scrollHeight,c=parseInt((l-e)/r()+1);l>e?n(c<=s?l+"px":o()+"px"):l<a&&n("")};return()=>{e.appendChild(i),l(t,i),a(),i.remove()}}var m=({closeModal:e,showModal:t,node:s},i,n,r,o)=>{const a=s.querySelector("input[type=text]");let l=null;s.querySelector("form").addEventListener("submit",(t=>(t.preventDefault(),null!=l&&(n(l),e()),!1)));const c=function(e,t,s,i,n){const r=e.parentNode,o=document.createElement("div"),a=document.createElement("ul"),l=document.createElement("div");o.classList.add("chat-autocomplete-container"),o.setAttribute("aria-live","asertive"),o.setAttribute("aria-relevant","additions"),o.setAttribute("role","status"),a.classList.add("chat-autocomplete"),a.classList.add("ilNoDisplay"),l.classList.add("ilNoDisplay"),l.appendChild(t.nothingFound),e.setAttribute("autocomplete","off"),o.appendChild(a),o.appendChild(l),r.appendChild(o);const c=t=>{n(t),e.value=t.value},h=n=>function(e,t,s){if(s.length<3)return Promise.resolve({items:[],hasMoreResults:!1,inputTooShort:!0});return t({search:s}).then((t=>({items:t.items.filter((t=>!e.includes(t.id))),hasMoreResults:t.hasMoreResults||!1})))}(s,n,e.value).then(function(e,t,s,i,n){return({items:r,hasMoreResults:o,inputTooShort:a})=>{const l=()=>{t.innerHTML="",t.classList.add("ilNoDisplay")},c=e=>()=>{l(),i(e)};if(0===r.length){if(!a)return l(),void s.classList.remove("ilNoDisplay");l()}else t.innerHTML="",t.classList.remove("ilNoDisplay");s.classList.add("ilNoDisplay"),r.forEach((s=>t.appendChild(function(e,t,s){const i=document.createElement("li"),n=document.createElement("button");return n.setAttribute("tabindex","0"),n.textContent=e.label,n.addEventListener("click",s),n.addEventListener("keydown",(e=>{({Enter:s,ArrowDown:()=>{(i.nextSibling||{querySelector:()=>t}).querySelector("button").focus()},ArrowUp:()=>{(i.previousSibling||{querySelector:()=>t}).querySelector("button").focus()}}[e.key]||f)()})),i.appendChild(n),i}(s,e,c(s))))),o&&t.appendChild(function(e,t){const s=document.createElement("li"),i=document.createElement("button");return i.classList.add("load-more"),i.textContent=e,s.appendChild(i),i.addEventListener("click",t),s}(n.label,(()=>{l(),n.load()})))}}(e,a,l,c,{load:()=>h((e=>i({...e,all:!0}))),label:t.more})),d=function(e,t){let s=f;return(...i)=>new Promise(((n,r)=>{s(),s=window.clearTimeout.bind(window,window.setTimeout((()=>e(...i).then(n).catch(r)),t))}))}((()=>h(i)),500);return e.addEventListener("input",(()=>{n(null),d()})),e.addEventListener("keydown",(e=>{"ArrowDown"===e.key&&a.firstChild?a.firstChild.querySelector("button").focus():"ArrowUp"===e.key&&a.lastChild&&a.lastChild.querySelector("button").focus()})),()=>{n(null),e.value="",a.innerHTML="",a.classList.add("ilNoDisplay"),l.classList.add("ilNoDisplay")}}(a,i,r,o,(e=>{l=e}));return()=>{c(),t()}};function f(){}var v=e=>(t,s={})=>{const i=new URL(e.replace(/postMessage/,t));return Object.entries(s).forEach((e=>y(i.searchParams,...e))),fetch(i)};function y(e,t,s){"object"==typeof s&&null!==s?Object.entries(s).forEach((([s,i])=>y(e,t+"["+s+"]",i))):e.set(t,s)}class b{#e;#t;constructor(e,t){this.#e=e,this.#t=t}heartbeatInterval(e){const t=()=>{};window.setInterval((()=>this.#s("poll",{},t)),e)}leavePrivateRoom(){this.#t.logILIASRequest("leavePrivateRoom"),this.#s("privateRoom-leave")}inviteToPrivateRoom(e,t){this.#s("inviteUsersToPrivateRoom-"+t,{user:e})}clear(){this.#s("clear")}kick(e){this.#s("kick",{user:e})}ban(e){this.#s("ban-active",{user:e})}#s(e,t={},s=(e=>this.#i(e))){this.#e(e,t).then((e=>e.json())).then(s)}#i(e){return this.#t.logILIASResponse("default"),!!e.success||(console.error(e.reason),!1)}}const L=()=>{},k=e=>new Promise((t=>o.onArrived(e,(({node:e,showModal:s,closeModal:i})=>{let n=L;e.querySelector("form").addEventListener("submit",(e=>(e.preventDefault(),n(!0),n=L,i(),!1))),t((()=>(s(),new Promise((e=>{n=e})))))}))));class C{#n;#r;#o;#a;#l;constructor(e,t){this.#n=e,this.#r=t,this.#o={},this.#a={},this.#l=()=>{}}imageOfUser(e){return this.#o[this.#c(e)]?Promise.resolve(this.#o[this.#c(e)]):this.#h(e)}imagesOfUsers(e){return Promise.all(e.map(this.imageOfUser.bind(this)))}defaultImage(){return this.#r}#h(e){return new Promise(((t,s)=>{const i=this.#c(e);this.#a[i]=this.#a[i]||{value:e,waiting:[]},this.#a[i].waiting.push({resolve:t,reject:s}),this.#l(),this.#l=clearTimeout.bind(null,setTimeout(this.#d.bind(this),20))}))}#d(){const e=Object.values(this.#a).map((({value:e})=>e)),t=fetch(this.#n,{method:"POST",body:JSON.stringify({profiles:e}),headers:{"Content-Type":"application/json"}}).then((e=>e.json()));t.then((e=>Object.entries(this.#u()).forEach((([t,{waiting:s}])=>s.forEach((({resolve:s,reject:i})=>{e[t]?(this.#o[t]=e[t],s(e[t])):i("Image not returned from server.")})))))),t.catch((e=>Object.values(this.#u()).flatMap((e=>e.waiting)).forEach((t=>t.reject(e)))))}#c(e){return JSON.stringify(e)}#u(){const e=this.#a;return this.#a={},e}}const S=(()=>{let e=0;return()=>(e++,"key-"+e)})(),w=e=>function(e){const t=S();return o.onArrived(t,e),t}((t=>t.addEventListener("click",e)));class E{#p;#e;#g;#m;#f;#v;#y;#b;constructor(e,t,s,i,n){this.#p=e,this.#e=t,this.#g=s,this.#m=i,this.#f=e&&e.querySelector(".no_users"),this.#v={},this.#y=[],this.#b=n}userListChanged(e){e.removed.forEach((({key:e})=>this.remove(e))),e.added.forEach((({value:e})=>this.add(e)))}add(e){if(this.#v[e.id])return!1;const t=this.#L(e);return this.#g(e.id)||this.#y.push(String(e.id)),this.#p.appendChild(t),this.#v[e.id]=t,this.#k(),!0}remove(e){const t=this.#v[e];return!!t&&(t.remove(),this.#y=this.#y.filter((t=>t!==e)),delete this.#v[e],this.#k(),!0)}setUsers(e){const t=e.map((e=>String(e.id)));Object.keys(this.#v).filter((e=>!t.includes(e))).forEach(this.remove.bind(this)),e.forEach(this.add.bind(this))}static actionList(e,t,s,i){return[{name:"kick",callback(e){s("kick-modal").then((s=>{s&&t.kick(e)}))}},{name:"ban",callback(e){s("ban-modal").then((s=>{s&&t.ban(e)}))}},{name:"chat",callback:i}]}#L(e){const t=document.createElement("div"),s=this.#e("view-userEntry",{username:e.username,user_id:e.id,actions:Object.fromEntries(this.#b.map((({name:t,callback:s})=>[t,w((()=>s(e.id)))])))}).then((e=>e.text())).then((e=>function(e,t){return e.innerHTML=t,Array.from(e.querySelectorAll("script"),(e=>{const t=document.createElement("script");t.appendChild(document.createTextNode(e.innerHTML)),e.parentNode.replaceChild(t,e)})),e}(t,e)));return t.classList.add("ilChatroomUser"),Promise.all([s,this.#m.imageOfUser(e)]).then((([e,s])=>{Array.from(t.querySelectorAll("img"),(e=>e.setAttribute("src",s)))})),this.#g(e.id)&&t.classList.add("ilNoDisplay"),t}#k(){this.#f.classList[this.#y.length?"add":"remove"]("ilNoDisplay")}}const U=(e,t)=>Object.keys(e).filter((e=>!Reflect.has(t,e))).map((t=>({key:t,value:e[t]})));class R{#C;#S;constructor(){this.#C={},this.#S=[]}find(e){return this.#C[e]}has(e){return Reflect.has(this.#C,String(e))}includes(e){return this.has(e)}onChange(e){this.#S.push(e)}add(e,t){e=String(e),this.#C[e]=t,this.#w({added:[{key:e,value:t}],removed:[]})}remove(e){if(e=String(e),!Reflect.has(this.#C,e))return;const t=this.#C[e];delete this.#C[e],this.#w({added:[],removed:[{key:e,value:t}]})}setAll(e){const t={added:U(e,this.#C),removed:U(this.#C,e)};this.#C=e,this.#w(t)}all(){return this.#C}#w(e){this.#S.forEach((t=>t(e)))}}var I=(e,t)=>{const s=t instanceof Date?t:new Date(t),i=(n=2,e=>"0".repeat(Math.max(0,n-String(e).length))+e);var n;return[["Y",s.getFullYear()],["m",i(s.getMonth()+1)],["d",i(s.getDate())],["h",i(s.getHours()%12||12)],["H",i(s.getHours())],["i",i(s.getMinutes())],["s",i(s.getSeconds())],["a",s.getHours()>11?"pm":"am"]].reduce(((e,[t,s])=>e.replace(t,s)),e)};class _{#p;#E;#U;#m;#R;#I;#_;#T;#A;#q;#x;#M;constructor(e,t,s,i,n,r,o){this.#p=e,this.#E=t,this.#U=s,this.#m=i,this.#R=n,this.#I=r,this.#_=o,this.#q=A(["messageContainer"]),this.#q.setAttribute("aria-live","polite"),this.#x=A(["typing-info"]),this.#x.setAttribute("aria-live","polite"),this.#M=q,this.#O(),this.clearMessages(),this.#j()}addMessage(e){this.#M();const t=A(["messageLine","chat",!e.target||e.target.public?"public":"private"]),s=()=>console.warn("Unknown message type: ",e.type);let i=null;const n=e=>{i=e};({message:()=>{const s=function(e,t){const s=A(["message-body"]);return s.appendChild(e),s.appendChild(t),s}(function(e,t){const s=A(["time-info"]);return s.textContent=I(t.time,e.timestamp),s}(e,this.#_),function(e){const t=A([],"p");return t.textContent=e.content,T(t),t}(e));this.#A(new Date(e.timestamp))&&(this.#q.appendChild(function(e,t){const s=A(["separator"]),i=A([],"p");return i.textContent=I(t.date,e.timestamp),s.appendChild(i),s}(e,this.#_)),n(null)),e.from.id===this.#E&&t.classList.add("myself"),this.#T&&this.#T.id===e.from.id&&this.#T.username===e.from.username?(this.#T.node.appendChild(s),n(this.#T)):(t.appendChild(function(e,t,s){const i=A(["user"],"span"),n=A(["user"],"span"),r=A([],"img"),o=A(["message-header"]);return i.textContent=I(s.time,e.timestamp),n.textContent=e.from.username,r.src=t.defaultImage(),t.imageOfUser(e.from).then(Reflect.set.bind(null,r,"src")),o.appendChild(r),o.appendChild(n),o.appendChild(i),o}(e,this.#m,this.#_)),t.appendChild(s),this.#q.appendChild(t),n({...e.from,node:t}))},connected:s,disconnected:s,private_room_entered:s,private_room_left:s,notice:()=>{const t=A(["separator","system-message"]),s=A([],"p");s.textContent=this.#I(e.content,e.data),t.appendChild(s),this.#q.appendChild(t)},error:s,userjustkicked:s}[e.type]||s)(),this.#T=i,this.#U.scrolling&&(this.#p.scrollTop=this.#q.getBoundingClientRect().height)}clearMessages(){this.#q.textContent="",this.#T=null,this.#A=function(){let e=null;return t=>{const s=!e||e.getDate()!==t.getDate()||e.getMonth()!==t.getMonth()||e.getFullYear()!==t.getFullYear();return e=t,s}}();const e=A(["separator"]),t=A([],"p");t.textContent=this.#I("welcome_to_chat"),e.appendChild(t),this.#q.appendChild(e),this.#M=e.remove.bind(e)}typingListChanged(){const e=Object.values(this.#R.all());0===e.length?this.#x.textContent="":1===e.length?this.#x.textContent=this.#I("chat_user_x_is_typing",e[0]):this.#x.textContent=this.#I("chat_users_are_typing")}enableAutoScroll(e){this.#U.scrolling=Boolean(e),this.#O()}enableSystemMessages(e){this.#U.show_auto_msg=Boolean(e),this.#O()}#j(){this.#p.appendChild(this.#q);const e=A(["fader"]);this.#p.appendChild(e),e.appendChild(this.#x)}#O(){this.#p.classList[this.#U.show_auto_msg?"remove":"add"]("hide-system-messages")}}const T=(()=>{let e=t=>{try{i.default.ExtLink.autolink(t)}catch(t){console.error("Disabling url linking. Reason:",t),e=q}};return t=>e(t)})();function A(e,t){const s=document.createElement(t||"div");return(e||[]).forEach((e=>s.classList.add(e))),s}function q(){}class x{#D;#P;#N;#H;#R;#F;#t;#B;constructor(e,t,s,i,n,r,o){this.#D=e,this.#P=t,this.#N=s,this.#H=i,this.#R=n,this.#F=r,this.#t=o}init(e){this.#B=e,this.#B.on("message",this.#J.bind(this)),this.#B.on("connect",(()=>{this.#B.emit("login",this.#D.login,this.#D.id,this.#D.profile_picture_visible)})),this.#B.on("user_invited",this.#K.bind(this)),this.#B.on("private_room_entered",this.#Y.bind(this)),this.#B.on("connected",this.#Q.bind(this)),this.#B.on("userjustkicked",this.#z.bind(this)),this.#B.on("userjustbanned",this.#G.bind(this)),this.#B.on("clear",this.#V.bind(this)),this.#B.on("notice",this.#W.bind(this)),this.#B.on("userStartedTyping",this.#X.bind(this)),this.#B.on("userStoppedTyping",this.#Z.bind(this)),this.#B.on("userlist",this.#$.bind(this)),this.#B.on("shutdown",(()=>{this.#B.removeAllListeners(),this.#B.close(),window.location.href=this.#F})),window.addEventListener("beforeunload",(()=>{this.#B.close()}))}enterRoom(){this.#t.logServerRequest("enterRoom"),this.#B.emit("enterRoom",this.#H)}onLoggedIn(e){this.#B.on("loggedIn",e)}userStartedTyping(){this.#t.logServerRequest("userStartedTyping"),this.#B.emit("userStartedTyping",this.#H)}userStoppedTyping(){this.#t.logServerRequest("userStoppedTyping"),this.#B.emit("userStoppedTyping",this.#H)}sendMessage(e){this.#B.emit("message",e,this.#H)}#J(e){this.#N.addMessage(e)}#K(e){}#Y(e){this.#t.logServerResponse("onPrivateRoomEntered")}#Q(e){Object.values(e.users).forEach((t=>{let s={id:t.id,username:t.login,profile_picture_visible:t.profile_picture_visible};this.#P.add(s),this.#N.addMessage({login:s.label,timestamp:e.timestamp,type:"connected"})}))}#z(e){this.#t.logServerResponse("onUserKicked"),this.#P.remove(this.#D.id),window.location.href=this.#F+"&msg=kicked"}#G(e){this.#B&&(this.#B.removeAllListeners(),this.#B.close()),window.location.href=this.#F+"&msg=banned"}#V(){this.#N.clearMessages()}#W(e){this.#N.addMessage(e)}#X(e){this.#t.logServerResponse("onUserStartedTyping");const t=JSON.parse(e.subscriber);this.#R.add(t.id,t.username)}#Z(e){this.#t.logServerResponse("onUserStoppedTyping");const t=JSON.parse(e.subscriber);this.#R.remove(t.id)}#$(e){const t=e.users;this.#t.logServerResponse("onUserlist"),this.#P.setAll(Object.fromEntries(Object.values(t).map((e=>{const t={id:e.id,username:e.username,profile_picture_visible:e.profile_picture_visible};return[t.id,t]}))))}}class M{#ee;#te;#l;constructor(e){this.#ee=e,this.#te=!1,this.#l=()=>{},window.addEventListener("beforeunload",this.release.bind(this))}release(){this.#l(),this.#te&&(this.#ee.userStoppedTyping(),this.#te=!1)}heartbeat(){this.#l(),this.#te||(this.#ee.userStartedTyping(),this.#te=!0),this.#l=clearTimeout.bind(null,setTimeout(this.release.bind(this),5e3))}}class O{release(){}heartbeat(){}}class j{logServerResponse(e){this.#se("Server-Response",e)}logServerRequest(e){this.#se("Server-Request",e)}logILIASResponse(e){this.#se("ILIAS-Response",e)}logILIASRequest(e){this.#se("ILIAS-Request",e)}#se(e,t){console.log(e,t)}}const D=e=>{const t=new R,s=new R,r=new j,a=v(e.apiEndpointTemplate),l=((e,t=(e=>"#"+e+"#"))=>(s,i,...n)=>{let r=e[s];return r?(Object.entries(i||{}).forEach((([e,t])=>{r=r.split("#"+e+"#").join(t)})),r):t(s,i,...n)})(e.lang,i.default.Language.txt.bind(i.default.Language)),c=(()=>{const e=(e=>{const t={};return s=>(t[s]||(t[s]=e(s)),t[s])})(k);return t=>e(t).then((e=>e()))})(),h=new C(e.initial.profile_image_url,e.initial.no_profile_image_url),d=new b(a,r),u=new E(H("chat_users"),a,(t=>t===e.initial.userinfo.id),h,function(e,t){const s=t.userinfo.moderator?["kick","ban","chat"]:["chat"];return e.filter((e=>s.includes(e.name)))}(E.actionList(l,d,c,function(e){return t=>i.default.Chat.getConversation([i.default.OnScreenChat.user,e.find(t)])}(t)),e.initial)),p=new _(H("chat_messages"),e.initial.userinfo.id,e.initial.state,h,s,l,e.dateTimeFormatStrings),f=new x(e.initial.userinfo,t,p,e.scope,s,e.initial.redirect_url,r);return{bindEvents:function(){t.onChange(u.userListChanged.bind(u)),s.onChange(p.typingListChanged.bind(p)),N("auto-scroll-toggle",(e=>p.enableAutoScroll(e))),N("system-messages-toggle",(e=>p.enableSystemMessages(e))),N("system-messages-toggle",(t=>function(e,t){return fetch(t.system_message_update_url,{method:"POST",body:new URLSearchParams({state:Number(e)})})}(t,e.initial))),o.onArrived("invite-modal",(s=>P("invite-button",m(s,{more:"Â»"+l("autocomplete_more"),nothingFound:e.nothingFound},(e=>d.inviteToPrivateRoom(e.id,"byId")),t,(({search:e,all:t})=>a("inviteUsersToPrivateRoom-getUserList",Object.assign({q:e},t?{fetchall:"1"}:{})).then((e=>e.json()))))))),P("clear-history-button",(()=>function(e,t){e("clear-history-modal").then((e=>{e&&t.clear()}))}(c,d))),((e,t,s)=>{const i=e.querySelector("#submit_message_text");e.querySelector("#submit_message").addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),r()}));const n=g(e.querySelector("#chat-shadow"),i,3);function r(){const e=i.value;if(""!==e.trim()){const r={content:e,format:{}};i.value="",s.release(),t(r),i.focus(),n()}}i.addEventListener("input",n),i.addEventListener("keydown",(e=>{13!==(e.keyCode||e.which)||e.shiftKey||(e.preventDefault(),e.stopPropagation(),i.blur(),r())})),i.addEventListener("keyup",(e=>{s[13===(e.keyCode||e.which)?"release":"heartbeat"]()}))})(H("send-message-group"),(e=>f.sendMessage(e)),e.initial.userinfo.broadcast_typing?new M(f):new O)},processInitialData:function(){(function(e,t){e.setAll(Object.fromEntries(t.users.map((e=>{const t={id:e.id,username:e.login,profile_picture_visible:e.profile_picture_visible};return[t.id,t]}))))})(t,e.initial),function(e,t){Object.values(t.messages).forEach((t=>{t.timestamp=1e3*t.timestamp,e.addMessage(t)}))}(p,e.initial)},connectToServer:function(){d.heartbeatInterval(12e4),f.init(n.default.connect(e.baseUrl+"/"+e.instance,{path:e.initial.subdirectory})),f.onLoggedIn((()=>{f.enterRoom(e.scope,0)}))}}};function P(e,t){o.onArrived(e,(e=>e.addEventListener("click",t)))}function N(e,t){P(e,(function(){t(this.classList.contains("on"))}))}function H(e){return document.getElementById(e)}i.default.Chatroom={run:e=>{const{bindEvents:t,processInitialData:s,connectToServer:i}=D(e);t(),s(),i(),H("submit_message_text").focus()},runReadOnly:e=>{const{processInitialData:t}=D(e);t()},createBus:r,bus:o,expandableTextarea:function(e,t,s){const i=e=>{const t=document.querySelector(e);return console.assert(null!==t,"Could not find selector "+JSON.stringify(e)),t};return g(i(e),i(t),s)},inviteUserToRoom:m,sendFromURL:v}}(il,io);
