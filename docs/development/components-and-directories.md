# Components and Directories

This document describes the big picture of the structure of the ILIAS source code.
On the one hand, the code is organized on the file system and in PHP namespaces.
On the other hand, the various components of ILIAS depend on each other in certain
ways and hence have a logical structure. Both aspects of structure are described
here. The document targets all ILIAS developers, as they all will work with and
in the presented structures.

The document was created to further the goals of the [Component Revision 2022](https://docu.ilias.de/goto.php?target=wiki_1357_Component_Revision_2022).
Hence, as of the creation of this document, the presented structure is not completely
implemented and instead a goal is described, towards which the community should
work.

Every section starts with a general topology of the problem at hand. It proceeds
with directions how the problem is solved in ILIAS and finishes with in-depth
explanations on why certain things should be as described.


## Filesystem and Namespaces

This part of the document describes the layout of the filesystem and the
PHP-Namespaces of the ILIAS code and the components that form the system. The
dependencies between the components are described in the chapter [Types of Dependencies and Integration Strategies](#types-of-dependencies-and-integration-strategies).

### Top-Level-Structure

This describes how the root level of the ILIAS repository and an installation
of ILIAS will look like. Many parts of a productive ILIAS installation are
automatically created via a build process, hence an installation will contain
more files than the ILIAS repository. Still, the structures of both should
match to allow developers to quickly find their way around and admins to
update installations via git.

#### How?

The root of the ILIAS repository contains the following directories and files:

* **`.github`** contains configuration for GitHub-integrations, such as workflows.
  Executables for this purpose are located in scripts. 
* **`cli`** contains executables for productive ILIAS systems that are to be run on
  the command line, such as the setup.php and cron.php.
* **`docs`** contains documentation that is relevant for the complete system.
  Individual components may have **`docs`**-folders as well that contain information
  only about that component.
* **`lang`**: contains language file as is
* **`components`** contains the code for ILIAS
* **`scripts`**: contains scripts to be used during development and for CI
* **`templates`**: contains style code and templates as is

On productive installations and for release packages, these folders will be amended
by some folders generated by a build-process: 

* **`cache`**: will contain generated artifacts from ILIAS
* **`Customizing`**: will contain language-modifications and additional skins,
  but no plugins anymore.
* **`node_modules`**: contains JavaScript-libraries as is
* **`vendor`**: contains PHP-libraries as is
* **`public`**: Contains files and folders that need to be exposed to the web,
  so this folder should be linked to www/html 

#### Why?

Configuration and scripts are splitted between **`.github`** and the **`scripts`**
so same scripts can be used by developers from the command line or integrated into
their IDEs. In general, this separation of concerns fosters a style of dev-scripts
that allows for custom automations at individual organisations that use ILIAS and
simplifies switching away from GitHub to another software forge.

**`cli`** and **`scripts`** are different folders because the further will be needed
on production systems while the latter should be removed on them as it is only used
for development purpose.

**`docs`** may also exist in individual components but then only has the scope of
that component. On the one hand, we need a systemwide entrypoint for documentation
to look into high level concepts, processes and provide direction to other resources.
On the other hand, documentation about certain components should be close to the
component in question,  

**`lang`**, **`template`** and **`Customizing`** stay as is for the time being, as
the system can only support a certain amount of change per timeframe. In the long
run it seems advisable to move these folders as well. **`lang`** might be a candidate
to be split up into single components as well. **`templates`** might be moved
completely into the UI-framework once legacy UI components are removed completely.
**`Customizing`** will be a candidate for future treatment once `lang` and `template`
are reconsidered.

**`public`** is introduced so installations can stop exposing each and every file
in the ILIAS repository. This is bad for security and reliability, as the ILILAS
repository contains loads of files that should not be accessible via web: files
containing automated tests, build artifacts, documentation.


### `components` Folder and Namespacing

The `components` folder is the central folder for the ILIAS development. It contains
components that are maintained and developed via the processes of the ILIAS society
and community. It may also contain components developed by third parties, formerly
known as plugins. Hence, this folder is an implementation of one central aim of
the [Component Revision 2022](https://docu.ilias.de/goto.php?target=wiki_1357_Component_Revision_2022):
Mechanisms used by core components and plugins should be aligned.

#### How

The top-level in the `components` starts with a list of all vendors that provide
components for the installation at hand. Hence, for a standard ILIAS, only one
folder `ILIAS` will be contained. When the installation uses plugins, the vendors
of the plugin will have folders as well.

The folders of the individual vendors in turn contain one folder for each component
provided by the vendor in question. Hence a component folder might look as such:

* ILIAS
  * AccessControl
  * Administration
  * Blog
  * Course
  * ...
* ServiceProvider1
  * Plugin1
  * Plugin2
* ServiceProvider2
  * Plugin1

Each of these folder contains an according component. The `\src` directory
in that folder contains the root of an according namespace, as described
by [PSR-4](https://www.php-fig.org/psr/psr-4/). For example: `components/ILIAS/AccessControl`
contains the component `ILIAS\AccessControl`, `components/ILIAS/AccessControl/src`
is the root of the namespace `ILIAS\AccessControl`.

A components folder also contains this substructure:

* `/docs` for component specific documentation
* `/src` for the code to be used for production
* `/tests` for code that performs automated tests
* a `$COMPONENT.php` (e.g. AccessControl.php) that defines the binding of the
  component to the rest of the system
* a `component.json` that contains component metadata, such as contact of
  maintainers
* a `README.md` that gives human readable info about the component

#### Why

PHP-Namespacing with its `Vendor\Package` logic is a good fit for ILIAS components.
It provides a natural way to resolve naming clashes between all component and
plugins and fits well in the general PHP ecosystem.

Although for a standard ILIAS installation the additional `ILIAS` folder in `components`
might seem unnecessary, it provides a natural way to add plugins from other vendors
and should make it easier for people finding a specific component. If for some reason
plugins should be backed up or in any other way be treated differently than ILIAS
components, this could still be implemented via a simple directory based approach,
as was also possible with the `Customizing` folder.

The superficial distinction between "Modules" and "Services" is dropped, as it doesn't
seem to be helpful anymore. On further iterations on the integration mechanism used
in ILIAS, it seems to be desirable that the idea, that one component (previously:
"Module") may only provide one type of repository object is dropped. This will clarify
the directory layout for components that in fact provide several repository objects,
such as `Course` and `CourseReference`.

The previous XML-based component definition is split into two distinct files.
**`component.json`** contains metadata about the component, such as names of
maintainers, version numbers and contacts. `$COMPONENT.php` defines, how the
component is integrated with other components of the system, e.g. the CronJobs
or the Event System.

The xml-based definition was droppped for various reasons:

* A custom XML format requires its own parser that needs to be maintained.
  The parser, in turn, needs custom mechanisms to be extended by other
  components.
* XML and PHP are equally expressive, but PHP-IDEs provide helpers like syntax
  highlighting or code completion for PHP and not for custom XML.
* The mechanism and approaches for writing and maintaining PHP code are well
  established in the ILIAS community. This is not true for XML.


## Types of Dependencies and Integration Strategies

*To save results and decide for (or against) their implementation, I decided to
not present my ideas regarding integration here yet. Proprosals for integration
strategies will be optional in the sense that we will totally have made progress
if we'd only implemented the proposed changes in directories.*


## Roadmap and Migration

* As of creation of the release_9-branch, CaT will ask for a quick stop in new
  commits and move existing code into the new file system structure.
  * The actual internal structure for the ILIAS component can be introduced bit
    by bit. Currently, most components in ILIAS rely on the classmap of composer
    anyway to locate classes in the codebase. This will simply keep working even
    if directories are moved inside the codebase. The classmap created by composer
    will simply point to other locations.
  * Most important endpoints and js-includes will be moved with the PR.
* If we could not agree on integration strategy and `$COMPONENT.php` by then:
  * We can continue to use service.xml/module.xml with minimal changes.
  * We can continue using Plugins as is with minimal changes.
  * CaT will provide further PRs that moves missing endpoints and client-side
    includes to `\public`.
* If we could agree on integration strategies and `$COMPONENT.php` by then:
  * ... we will have discussed how to move existing integrations via xmls to new
    logic:
* CaT will provide migrations and howtos to move existing installations to new
  structure.
